---
import retrieveData from "../../components/datocms/connector";
import { getLangFromUrl } from "../../i18n/utils";
import PageLayout from "../../layouts/PageLayout.astro";
import { languages } from "../../i18n/translations";
import { StructuredText } from "../../components/datocms";

// Structured text components
import { HeadingWithAnchorLink } from '../../components/datocms/HeadingWithAnchorLink';
import { PageInline } from '../../components/datocms/inlineRecord/PageInline';
import { PageLink } from '../../components/datocms/linkToRecord/PageLink';
import { VideoBlock } from '../../components/datocms/blocks/VideoBlock';
import { ImageBlock } from '../../components/datocms/blocks/ImageBlock';
import { ImageGalleryBlock } from '../../components/datocms/blocks/ImageGalleryBlock';


export async function getStaticPaths() {
  const data = await retrieveData("fetchAllPages");
  const allPages = data?.allPages || [];

  const paths = [];
  for (const page of allPages) {
    const pageData = await retrieveData("fetchPage", {
      slug: { eq: page.slug },
    });

    for (const locale of Object.keys(languages)) {
      paths.push({
        params: {
          locale,
          slug: page.slug,
        },
        props: {
          page,
          pageData,
        },
      });
    }
  }

  return paths;
}

const { page, pageData } = Astro.props;

const lang = getLangFromUrl(Astro.url);
---

<PageLayout
  pageTitle={page.title}
  pageDescription={page.title}
  pageUrl={Astro.params.slug}
>
  <div class="[&_p]:my-6 [&_h2]:my-8 [&_h3]:my-8 [&_h4]:my-8 [&_h5]:my-8 [&_h6]:my-8 [&_img]:mt-6 [&_figcaption]:mb-6 [&_ul]:my-6 [&_ol]:my-6 [&_hr]:my-10">
    <StructuredText
      data={pageData.page.structuredText}
      blockComponents={/*
      * If the structured text embeds any blocks, it's up to you to decide
      * how to render them:
      */
      {
        ImageBlockRecord: ImageBlock,
        ImageGalleryBlockRecord: ImageGalleryBlock,
        VideoBlockRecord: VideoBlock,
      }}
      linkToRecordComponents={/*
      * If the structured text includes a link to another DatoCMS record,
      * it's your decision to determine where the link should lead, or if
      * you wish to customize its appearance:
      */
      {
        PageRecord: PageLink,
      }}
      inlineRecordComponents={/*
      * If the structured text includes a reference to another DatoCMS
      * record, it's up to you to decide how to render them:
      */
      {
        PageRecord: PageInline,
      }}
      nodeOverrides={/*
      * You can also override the default rendering of certain nodes.
      * In this case, we want to tweak the way headings (h1-h6) are rendered.
      */ {
        heading: HeadingWithAnchorLink,
      }}
    />
  </div>
</PageLayout>
