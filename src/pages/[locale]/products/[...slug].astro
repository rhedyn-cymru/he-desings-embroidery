---
import retrieveData from "../../../components/datocms/connector";
import { getLangFromUrl } from "../../../i18n/utils";
import PageLayout from "../../../layouts/ProductLayout.astro";
import { languages } from "../../../i18n/translations";
import { StructuredText } from "../../../components/datocms";

// Structured text components
import { HeadingWithAnchorLink } from "../../../components/datocms/HeadingWithAnchorLink";
import { PageInline } from "../../../components/datocms/inlineRecord/PageInline";
import { PageLink } from "../../../components/datocms/linkToRecord/PageLink";
import { VideoBlock } from "../../../components/datocms/blocks/VideoBlock";
import { ImageBlock } from "../../../components/datocms/blocks/ImageBlock";
import { ImageGalleryBlock } from "../../../components/datocms/blocks/ImageGalleryBlock";

export async function getStaticPaths() {
  const data = await retrieveData("fetchAllProducts");
  const allProducts = data?.allProducts || [];

  const paths = [];
  for (const page of allProducts) {
    const productData = await retrieveData("fetchProduct", {
      slug: { eq: page.slug },
    });

    for (const locale of Object.keys(languages)) {
      paths.push({
        params: {
          locale,
          slug: page.slug,
        },
        props: {
          page,
          productData,
        },
      });
    }
  }

  return paths;
}

const { page, productData } = Astro.props;

const lang = getLangFromUrl(Astro.url);
---

<PageLayout
  pageTitle={page.title}
  pageDescription={page.title}
  pageUrl={`/${lang}/${Astro.params.slug}/`}
  pageImage={productData.product.images[0].url}
>
  <article class="grid grid-cols-2 gap-6">
    {
      productData.product.images && (
        <div class="product-images">
          {productData.product.images.map((image) => (
            <figure>
              <img src={image.url} alt={image.alt} class="rounded" />
            </figure>
          ))}
        </div>
      )
    }
    <div>
      <h1 class="colour-special text-3xl mb-2">{page.title}</h1>
      <StructuredText
      data={productData.product.structuredText}
      blockComponents={/*
       * If the structured text embeds any blocks, it's up to you to decide
       * how to render them:
       */
      {
        ImageBlockRecord: ImageBlock,
        ImageGalleryBlockRecord: ImageGalleryBlock,
        VideoBlockRecord: VideoBlock,
      }}
      linkToRecordComponents={/*
       * If the structured text includes a link to another DatoCMS record,
       * it's your decision to determine where the link should lead, or if
       * you wish to customize its appearance:
       */
      {
        PageRecord: PageLink,
      }}
      inlineRecordComponents={/*
       * If the structured text includes a reference to another DatoCMS
       * record, it's up to you to decide how to render them:
       */
      {
        PageRecord: PageInline,
      }}
      nodeOverrides={/*
       * You can also override the default rendering of certain nodes.
       * In this case, we want to tweak the way headings (h1-h6) are rendered.
       */ {
        heading: HeadingWithAnchorLink,
      }}
    />
    </div>
  </article>
</PageLayout>
