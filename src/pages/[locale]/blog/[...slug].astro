---
import { getCollection, render } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import { getLangFromUrl, useTranslations } from "../../../i18n/utils";
import { defaultLang, languages } from "../../../i18n/translations";
import defaultBlogCard from "../../../assets/default-blog-card.png"

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");

  // 1. Use posts in the default language as the "master list"
  const basePosts = allPosts.filter((post) => post.data.locale === defaultLang);

  return Object.entries(languages).flatMap(([locale]) => {
    return basePosts.map((basePost) => {
      // Try to find a translated post with the same id (accounting for trailing dash)
      const baseId = basePost.id.replace(/\-$/, "");
      const translatedPost = allPosts.find(
        (p) => p.data.locale === locale && p.id.replace(/\-$/, "") === baseId
      );

      return {
        params: { locale, slug: baseId },
        props: {
          post: translatedPost || basePost, // Provide `post` prop expected by the page
          isFallback: !translatedPost,
        },
      };
    });
  });
}

const { post, isFallback } = Astro.props;
const t = useTranslations(post.data.locale);
const { Content } = await render(post);

const lang = getLangFromUrl(Astro.url);
---

<Layout
  locale={lang}
  pageTitle={post.data.title}
  pageDescription={post.data.description}
  pageImage={post.data.image}
  pageUrl={`/${lang}/blog/${Astro.params.slug}/`}
>
  <section class="container">
    {
      isFallback && (
        <div class="callout warning margin-start-s">
          <p>Mae'n ddrwg gen i, dim cyfieithiad ar gael eto</p>
        </div>
      )
    }
    <h1 class="colour-special">{post.data.title}</h1>
    <img src={post.data.image} alt=""/>
    <div>
      <strong>{t("Published on")}:</strong>&nbsp;{post.data.date}<br />
      <strong>{t("Author")}:</strong>&nbsp;
      {post.data.author}<br />
      <div class="flex gap-4xs">
        <strong>{t("Tags")}:</strong>
        {post.data.tags.map((tag) => <span class="badge">{tag}</span>)}
      </div><br />
    </div>
    <article class="margin-end-m">
      <Content />
    </article>
    <a href={`/${lang}/blog/`} class="btn">&laquo; {t("All articles")}</a>
  </section>
</Layout>
